# F-Gateway 商品マスタ管理設計書

| 項目 | 内容 |
|------|------|
| 文書番号 | DEV-GATEWAY-ITEM-001 |
| 版数 | 1.2 |
| ステータス | 設計中 |
| 最終更新 | 2026-01-29 |

---

## 1. 概要

### 1.1 目的

F-Gatewayにおける**商品マスタ管理**は、クライアントごとに異なる商品マスタ仕様を柔軟に吸収し、Friendslogi社内の標準フォーマットに変換して管理する重要な機能です。

### 1.2 商品マスタ管理の重要性

| 重要性 | 説明 |
|--------|------|
| **在庫精度の向上** | 最新の商品情報により、在庫管理の精度が向上 |
| **出荷ミスの防止** | 正確な商品コード・JANコードにより、誤出荷を防止 |
| **業務効率化** | 商品情報の一元管理により、問い合わせ対応を効率化 |
| **データ鮮度の維持** | 定期更新により、陳腐化したデータを排除 |

### 1.3 設計方針

| 方針 | 説明 |
|------|------|
| **巨大CSV対応** | 数万件規模のCSVファイルを処理可能 |
| **柔軟な項目マッピング** | クライアントごとに異なる列定義に対応 |
| **手動・自動の両対応** | CSVアップロード + URL自動取得 |
| **必須項目の厳密管理** | 社内標準項目への変換を保証 |
| **データ鮮度の可視化** | 最終更新日を表示し、定期更新を促進 |

---

## 2. 機能概要

### 2.1 クライアント側機能

| 機能 | 説明 |
|------|------|
| **商品マスタ一覧表示** | 自社の商品マスタをテーブル形式で表示（ページネーション対応） |
| **CSV手動アップロード** | Google Driveを経由して商品マスタCSVをアップロード |
| **更新状況の可視化** | 最終更新日、経過日数を表示 |
| **検索・フィルタ機能** | 商品コード、商品名、JANコードでの検索 |
| **CSVダウンロード** | 現在の商品マスタをCSV形式でダウンロード |

### 2.2 管理者側機能

| 機能 | 説明 |
|------|------|
| **必須項目定義** | 社内標準の必須項目を定義・管理 |
| **項目マッピング設定** | クライアントのCSV列 → 社内標準項目への紐付け |
| **URL自動取得設定** | クライアントの商品マスタURLを設定し、毎日自動取得 |
| **取得スケジュール管理** | 自動取得の時刻・頻度を設定 |
| **インポート履歴** | 過去のインポート履歴・エラーログを表示 |
| **バリデーションルール** | 必須項目のチェック、データ型の検証 |

---

## 3. データモデル

### 3.1 テーブル設計

#### item_master_definitions（商品マスタ項目定義）

社内標準の必須項目を定義するテーブル。

| カラム | 型 | 説明 |
|--------|-----|------|
| id | uuid | 主キー |
| field_name | varchar(50) | 項目名（item_code, item_name等） |
| field_type | varchar(20) | データ型（string, integer, decimal） |
| is_required | boolean | 必須フラグ |
| default_value | text | デフォルト値 |
| validation_rule | jsonb | バリデーションルール（正規表現等） |
| display_order | integer | 表示順序 |
| created_at | timestamp | 作成日時 |
| updated_at | timestamp | 更新日時 |

**標準必須項目例**:

| field_name | field_type | is_required | 説明 |
|-----------|-----------|-------------|------|
| `item_code` | string | true | 商品コード（クライアント独自） |
| `item_name` | string | true | 商品名 |
| `jan_code` | string | false | JANコード |
| `internal_item_code` | string | true | 社内商品コード（変換後） |
| `unit_price` | decimal | false | 単価 |
| `weight` | decimal | false | 重量（g） |
| `dimensions` | string | false | サイズ（W×D×H） |

#### client_item_mappings（クライアント別項目マッピング）

クライアントのCSV列を社内標準項目に紐付ける。

| カラム | 型 | 説明 |
|--------|-----|------|
| id | uuid | 主キー |
| client_id | uuid | クライアントID（FK） |
| client_column_name | varchar(100) | クライアントのCSV列名 |
| standard_field_name | varchar(50) | 社内標準項目名（FK） |
| transform_rule | jsonb | 変換ルール（正規表現、計算式等） |
| is_active | boolean | 有効フラグ |
| created_at | timestamp | 作成日時 |
| updated_at | timestamp | 更新日時 |

**マッピング例**:

| クライアント | client_column_name | standard_field_name | transform_rule |
|------------|-------------------|---------------------|---------------|
| DAQ | `品番` | `item_code` | - |
| DAQ | `商品名称` | `item_name` | - |
| DAQ | `JAN` | `jan_code` | - |
| MNG | `Code` | `item_code` | - |
| MNG | `ProductName` | `item_name` | - |

#### client_item_masters（クライアント商品マスタ）

クライアントごとの商品マスタの実データ。

| カラム | 型 | 説明 |
|--------|-----|------|
| id | uuid | 主キー |
| client_id | uuid | クライアントID（FK） |
| import_log_id | uuid | インポートログID（FK） |
| item_code | varchar(100) | 商品コード |
| item_name | varchar(255) | 商品名 |
| jan_code | varchar(13) | JANコード |
| internal_item_code | varchar(100) | 社内商品コード |
| raw_data | jsonb | 元のCSVデータ（全列を保持） |
| is_active | boolean | 有効フラグ |
| last_updated_at | timestamp | 最終更新日時 |
| created_at | timestamp | 作成日時 |

> **Note**: `raw_data`にクライアントの元のCSVデータを全列保持し、柔軟性を確保。

#### item_import_logs（商品マスタインポートログ）

インポート履歴を記録。

| カラム | 型 | 説明 |
|--------|-----|------|
| id | uuid | 主キー |
| client_id | uuid | クライアントID（FK） |
| import_type | varchar(20) | インポート種別（manual, auto_url） |
| source_type | varchar(50) | ソース種別（csv_upload, url_fetch） |
| source_url | varchar(500) | 自動取得元URL（自動取得の場合） |
| file_name | varchar(255) | ファイル名 |
| file_size | bigint | ファイルサイズ（bytes） |
| total_rows | integer | 総行数 |
| success_rows | integer | 成功行数 |
| error_rows | integer | エラー行数 |
| import_status | varchar(20) | インポート状態（success, partial, failed） |
| error_details | jsonb | エラー詳細 |
| started_at | timestamp | 開始日時 |
| completed_at | timestamp | 完了日時 |
| created_at | timestamp | 作成日時 |

#### client_item_sync_settings（商品マスタ自動取得設定）

URL自動取得の設定。

| カラム | 型 | 説明 |
|--------|-----|------|
| id | uuid | 主キー |
| client_id | uuid | クライアントID（FK） |
| sync_enabled | boolean | 自動取得有効フラグ |
| source_url | varchar(500) | 取得元URL |
| auth_type | varchar(20) | 認証方式（none, basic, bearer, api_key） |
| auth_credentials | text | 認証情報（暗号化） |
| sync_schedule | varchar(50) | 取得スケジュール（daily, weekly等） |
| sync_time | time | 取得時刻 |
| last_sync_at | timestamp | 最終取得日時 |
| next_sync_at | timestamp | 次回取得日時 |
| is_active | boolean | 有効フラグ |
| created_at | timestamp | 作成日時 |
| updated_at | timestamp | 更新日時 |

---

## 4. 処理フロー

### 4.1 手動CSVアップロードフロー

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Manual CSV Upload Flow                                   │
└─────────────────────────────────────────────────────────────────────────────┘

  [Client]                    [F-Gateway]                    [Database]

  (1) Upload CSV
      │
      v
  ┌──────────────┐
  │ Google Drive │
  │ (Item Master)│
  └──────┬───────┘
         │
         │ (2) Detect Upload
         v
                                ┌──────────────┐
                                │ File Monitor │
                                └──────┬───────┘
                                       │
                                       │ (3) Download & Parse
                                       v
                                ┌──────────────┐
                                │ CSV Parser   │
                                │ - Detect     │
                                │   Encoding   │
                                │ - Read Rows  │
                                └──────┬───────┘
                                       │
                                       │ (4) Mapping
                                       v
                                ┌──────────────┐
                                │ Field Mapper │
                                │ - Apply      │
                                │   Mappings   │
                                │ - Validate   │
                                └──────┬───────┘
                                       │
                        ┌──────────────┼──────────────┐
                        │              │              │
                        v              v              v
                 [Validation      [Transform    [Store Raw
                     Error]          Data]         Data]
                        │              │              │
                        v              v              v
                 ┌──────────┐   ┌──────────┐   ┌──────────┐
                 │  Asana   │   │ Database │   │ Database │
                 │  Notify  │   │  Insert  │   │  (JSONB) │
                 └──────────┘   └──────────┘   └──────────┘
```

### 4.2 URL自動取得フロー

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Auto URL Fetch Flow                                      │
└─────────────────────────────────────────────────────────────────────────────┘

  [Scheduler]                 [F-Gateway]                    [External]

  (1) Daily Trigger
      │
      v
  ┌──────────────┐
  │ Vercel Cron  │
  │ 03:00 JST    │
  └──────┬───────┘
         │
         │ (2) Check Sync Settings
         v
                                ┌──────────────┐
                                │ Sync Manager │
                                │ - Query      │
                                │   Active     │
                                │   Settings   │
                                └──────┬───────┘
                                       │
                                       │ (3) Fetch from URL
                                       v
                                ┌──────────────┐
                                │ HTTP Client  │
                                │ - Auth       │
                                │ - Download   │
                                │   CSV        │
                                └──────┬───────┘
                                       │
                                       v
                              [Same as Manual
                               Upload Flow]
```

---

## 5. 巨大CSV対応設計

### 5.1 パフォーマンス要件

| 項目 | 要件 |
|------|------|
| **最大ファイルサイズ** | 100MB |
| **最大行数** | 100,000行 |
| **処理時間** | 10,000行を1分以内 |
| **メモリ使用量** | ストリーム処理で抑制 |

### 5.2 ストリーム処理

巨大CSVはストリーム処理で行単位に読み込み、メモリ使用量を抑制。

```typescript
import { parse } from 'csv-parse';
import fs from 'fs';

async function importLargeCSV(filePath: string) {
  const parser = fs
    .createReadStream(filePath)
    .pipe(parse({
      columns: true,
      skip_empty_lines: true,
      encoding: 'utf-8' // or 'shift_jis'
    }));

  let batch = [];
  const BATCH_SIZE = 1000;

  for await (const record of parser) {
    batch.push(record);

    if (batch.length >= BATCH_SIZE) {
      await processBatch(batch);
      batch = [];
    }
  }

  // 残りのバッチを処理
  if (batch.length > 0) {
    await processBatch(batch);
  }
}
```

### 5.3 バッチインサート

データベースへの挿入は1000件ごとのバッチで実行。

```sql
-- PostgreSQL COPY コマンドで高速インポート
COPY client_item_masters (client_id, item_code, item_name, jan_code, raw_data)
FROM '/tmp/import_data.csv'
WITH (FORMAT csv, HEADER true, DELIMITER ',');
```

### 5.4 エンコーディング自動検出

クライアントから提出されるCSVファイルは **UTF-8** または **Shift_JIS** のいずれかでエンコードされている可能性があるため、システムは自動的にエンコーディングを検出して適切に処理する。

#### 対応エンコーディング

| エンコーディング | 検出方法 | 特徴 |
|-----------------|---------|------|
| **UTF-8 (BOM付き)** | BOMバイト検出 | `0xEF 0xBB 0xBF` で始まる |
| **UTF-8 (BOM無し)** | バイトシーケンス検証 | 日本語は3バイトシーケンス |
| **Shift_JIS** | UTF-8検証失敗時のフォールバック | レガシーWindows環境で使用 |

#### 検出アルゴリズム

```typescript
function detectEncoding(buffer: Buffer): string {
  // 1. BOM (Byte Order Mark) の検出
  if (buffer[0] === 0xEF && buffer[1] === 0xBB && buffer[2] === 0xBF) {
    return 'utf-8'
  }

  // 2. UTF-8 バイトシーケンス検証
  //    - 1バイト: 0x00-0x7F (ASCII)
  //    - 2バイト: 110xxxxx 10xxxxxx
  //    - 3バイト: 1110xxxx 10xxxxxx 10xxxxxx (日本語)
  //    - 4バイト: 11110xxx 10xxxxxx 10xxxxxx 10xxxxxx
  const isValidUtf8 = validateUtf8ByteSequence(buffer)

  if (isValidUtf8) {
    return 'utf-8'
  }

  // 3. UTF-8として無効な場合はShift_JISと判定
  return 'Shift_JIS'
}
```

#### UTF-8 バイトシーケンス検証の詳細

| バイト数 | 先頭バイト | 継続バイト | 用途 |
|---------|-----------|-----------|------|
| 1バイト | `0xxxxxxx` (0x00-0x7F) | - | ASCII文字 |
| 2バイト | `110xxxxx` (0xC0-0xDF) | `10xxxxxx` | ラテン拡張等 |
| 3バイト | `1110xxxx` (0xE0-0xEF) | `10xxxxxx` x2 | **日本語文字** |
| 4バイト | `11110xxx` (0xF0-0xF7) | `10xxxxxx` x3 | 絵文字等 |

> **重要**: 日本語文字（ひらがな、カタカナ、漢字）はUTF-8では3バイトシーケンスで表現される。Shift_JISでは2バイトで表現されるため、バイトパターンが異なる。この違いを利用してエンコーディングを判定する。

#### 改行コード対応

| 改行コード | OS | バイト列 | 対応 |
|-----------|-----|---------|------|
| LF | Unix/Linux/macOS | `0x0A` | 対応 |
| CRLF | Windows | `0x0D 0x0A` | 対応 |
| CR | 旧macOS | `0x0D` | 対応 |

すべての改行コードは内部処理前にLFに正規化される。

```typescript
// 改行コードの正規化
content = content.replace(/\r\n/g, '\n').replace(/\r/g, '\n')
```

#### ヘッダー検出の最適化

巨大CSVファイル（数十MB以上）のエンコーディング検出を高速化するため、以下の最適化を実施。

| 最適化項目 | 設定値 | 説明 |
|-----------|--------|------|
| **ヘッダー検出用読み取り** | 64KB | ファイル先頭64KBのみ読み取り |
| **エンコーディング検証** | 4KB | 先頭4KBのバイトシーケンスを検証 |

```typescript
const MAX_BYTES_TO_READ = 64 * 1024  // 64KB
const bytesToRead = Math.min(file.size, MAX_BYTES_TO_READ)
const slicedFile = file.slice(0, bytesToRead)
```

#### エラーハンドリング

| エラー | 対応 |
|--------|------|
| エンコーディング検出失敗 | UTF-8としてフォールバック処理 |
| デコードエラー | iconv-liteでShift_JIS→UTF-8変換を試行 |
| 不正なバイトシーケンス | 該当文字を置換または除外 |

---

## 6. 項目マッピング設計

### 6.1 マッピング設定画面（Admin）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  F-Gateway Admin > Clients > DAQ > Item Mapping                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  商品マスタ項目マッピング設定                                                │
│                                                                             │
│  ┌─── CSVサンプル ────────────────────────────────────────────────────────┐  │
│  │                                                                       │  │
│  │  品番,商品名称,JAN,標準価格,重量                                        │  │
│  │  DAQ-001,Tシャツ白S,4901234567890,1980,150                             │  │
│  │  DAQ-002,Tシャツ白M,4901234567891,1980,160                             │  │
│  │                                                                       │  │
│  │  [CSVサンプルをアップロード]                                            │  │
│  │                                                                       │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  ┌─── 項目マッピング ─────────────────────────────────────────────────────┐  │
│  │                                                                       │  │
│  │  社内標準項目              クライアントCSV列            変換ルール      │  │
│  │  ─────────────────────────────────────────────────────────────────────│  │
│  │  item_code [必須]    <-    [品番             ▼]       [変換なし ▼]    │  │
│  │  item_name [必須]    <-    [商品名称         ▼]       [変換なし ▼]    │  │
│  │  jan_code            <-    [JAN              ▼]       [変換なし ▼]    │  │
│  │  internal_item_code  <-    [品番             ▼]       [DAQ-{値} ▼]    │  │
│  │  unit_price          <-    [標準価格         ▼]       [変換なし ▼]    │  │
│  │  weight              <-    [重量             ▼]       [変換なし ▼]    │  │
│  │                                                                       │  │
│  │  [+ 項目を追加]                                                        │  │
│  │                                                                       │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  [マッピングをテスト]  [保存]                                                │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 変換ルール

| 変換ルール | 説明 | 例 |
|-----------|------|-----|
| **変換なし** | そのまま使用 | `1980` → `1980` |
| **プレフィックス追加** | クライアントコードを付与 | `001` → `DAQ-001` |
| **正規表現抽出** | パターンマッチで抽出 | `商品名(ABC-123)` → `ABC-123` |
| **固定値** | 常に固定値を設定 | - → `default_value` |
| **計算式** | 他の列を使った計算 | `price * 1.1` → 税込価格 |

---

## 7. URL自動取得設計

### 7.1 対応URL形式

| 形式 | 説明 | 認証 |
|------|------|------|
| **直接CSV URL** | `https://example.com/items.csv` | なし / Basic / Bearer |
| **Google Sheets公開URL** | `https://docs.google.com/spreadsheets/d/.../export?format=csv` | なし |
| **API エンドポイント** | `https://api.example.com/v1/items` | API Key / Bearer Token |

### 7.2 自動取得設定画面（Admin）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  F-Gateway Admin > Clients > DAQ > Auto Sync Settings                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  商品マスタ自動取得設定                                                      │
│                                                                             │
│  ┌─── 基本設定 ───────────────────────────────────────────────────────────┐  │
│  │                                                                       │  │
│  │  [x] 自動取得を有効にする                                              │  │
│  │                                                                       │  │
│  │  取得元URL:                                                            │  │
│  │  [https://example.com/api/items.csv                              ]   │  │
│  │                                                                       │  │
│  │  取得スケジュール:                                                     │  │
│  │  [毎日 ▼]  [03:00 ▼]                                                  │  │
│  │                                                                       │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  ┌─── 認証設定 ───────────────────────────────────────────────────────────┐  │
│  │                                                                       │  │
│  │  認証方式: [Bearer Token ▼]                                            │  │
│  │                                                                       │  │
│  │  Token: [****************************************]  [表示]            │  │
│  │                                                                       │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  ┌─── テスト実行 ─────────────────────────────────────────────────────────┐  │
│  │                                                                       │  │
│  │  [今すぐ取得してテスト]                                                │  │
│  │                                                                       │  │
│  │  最終取得: 2026-01-28 03:00  (成功: 1,234件)                           │  │
│  │  次回取得: 2026-01-29 03:00                                            │  │
│  │                                                                       │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  [保存]                                                                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.3 スケジュール設定

| スケジュール | 説明 |
|------------|------|
| **毎日** | 毎日指定時刻に実行 |
| **毎週** | 毎週指定曜日・時刻に実行 |
| **毎月** | 毎月指定日・時刻に実行 |

---

## 8. クライアント側UI

### 8.1 商品マスタ一覧画面

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  F-Gateway > 商品マスタ                   [DAQ]   goto@daq.jp      [Logout] │
├────────┬────────────────────────────────────────────────────────────────────┤
│        │                                                                    │
│ Menu   │  商品マスタ                                                         │
│        │  T-shirts.sc                                                       │
│ [Dashboard]                                                                 │
│ [Shipping]  ┌─── 更新状況 ─────────────────────────────────────────────┐   │
│ [Receiving] │                                                          │   │
│ [Items]     │  最終更新: 2026-01-27 14:30  (1日前)  [緑 OK]            │   │
│        │    │                                                          │   │
│        │    │  推奨: 商品マスタは可能な限り毎日更新してください         │   │
│        │    │  在庫情報の精度向上につながります。                       │   │
│        │    │                                                          │   │
│        │    │  [CSVアップロード]  [CSVダウンロード]                     │   │
│        │    │                                                          │   │
│        │    └──────────────────────────────────────────────────────────┘   │
│        │                                                                    │
│        │    ┌─── 検索・フィルタ ───────────────────────────────────────┐   │
│        │    │                                                          │   │
│        │    │  [検索: 商品コード、商品名、JAN           ]  [検索]      │   │
│        │    │                                                          │   │
│        │    └──────────────────────────────────────────────────────────┘   │
│        │                                                                    │
│        │    ┌─── 商品マスタ一覧 (1,234件) ────────────────────────────┐   │
│        │    │                                                          │   │
│        │    │  商品コード  商品名          JAN           更新日        │   │
│        │    │  ─────────────────────────────────────────────────────  │   │
│        │    │  DAQ-001     Tシャツ白S      4901234567890  1日前       │   │
│        │    │  DAQ-002     Tシャツ白M      4901234567891  1日前       │   │
│        │    │  DAQ-003     Tシャツ白L      4901234567892  1日前       │   │
│        │    │  DAQ-004     Tシャツ黒S      4901234567893  5日前       │   │
│        │    │  DAQ-005     Tシャツ黒M      4901234567894  8日前       │   │
│        │    │              [警告: 7日以上更新なし]      [赤 Alert]    │   │
│        │    │  ...                                                     │   │
│        │    │                                                          │   │
│        │    │  1ページ目 / 124ページ  [< 前へ]  [次へ >]               │   │
│        │    │                                                          │   │
│        │    └──────────────────────────────────────────────────────────┘   │
│        │                                                                    │
└────────┴────────────────────────────────────────────────────────────────────┘
```

**特徴**:
- ページネーション対応（1ページ10件）
- 検索機能（商品コード、商品名、JANコード）
- 更新日表示・色分け
- CSVダウンロード機能

### 8.2 更新遅延の表示ルール

| 経過日数 | 表示 | 色 |
|---------|------|-----|
| 0-1日 | `最新` | 緑色 |
| 2-6日 | `○日前` | 黄色 |
| 7日以上 | `警告：○日間更新なし` | 赤色 |

---

## 9. エラーハンドリング

### 9.1 バリデーションエラー

| エラー種別 | 対応 |
|-----------|------|
| **必須項目不足** | エラー行をスキップ、Asana通知 |
| **データ型不一致** | エラー行をスキップ、Asana通知 |
| **重複商品コード** | 既存データを更新 |
| **文字コードエラー** | 自動検出・変換試行 |

### 9.2 Asana通知フォーマット

```
【F-Gateway】商品マスタインポートエラー

クライアント: DAQ (T-shirts.sc)
ファイル名: item_master_20260128.csv
インポート日時: 2026-01-28 03:15:32

インポート結果:
- 総行数: 1,234行
- 成功: 1,220行
- エラー: 14行

エラー詳細:
- 行5: 必須項目「商品コード」が空です
- 行12: 必須項目「商品名」が空です
- 行23: JANコードの形式が不正です（13桁必須）

対応をお願いします。
```

---

## 10. セキュリティ

### 10.1 認証情報の管理

| 情報 | 保存方法 |
|------|---------|
| **Bearer Token** | 暗号化して`auth_credentials`に保存 |
| **API Key** | 暗号化して`auth_credentials`に保存 |
| **Basic認証** | Base64 + 暗号化 |

### 10.2 アクセス制御

| ロール | 権限 |
|--------|------|
| **Client** | 自社の商品マスタのみ閲覧・アップロード可能 |
| **Admin** | 全クライアントの商品マスタ閲覧・設定変更可能 |

---

## 11. バックグラウンド処理アーキテクチャ

### 11.1 設計方針

Vercelの制限（4.5MBペイロード、60秒タイムアウト）を回避するため、「受付は即座に、処理はバックグラウンド」の設計を採用。

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│  BACKGROUND PROCESSING ARCHITECTURE                                             │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌──────────┐    ┌─────────────┐    ┌──────────────┐    ┌────────────────────┐ │
│  │  Browser │───>│   Vercel    │───>│ Vercel Blob  │───>│     Inngest        │ │
│  │          │    │  (受付のみ)  │    │  (Storage)   │    │ (Background Job)   │ │
│  └──────────┘    └─────────────┘    └──────────────┘    └─────────┬───────────┘ │
│       │                                                           │             │
│       │          Client Upload                                    │             │
│       └──────────(Presigned URL)──────────────────────────────────┘             │
│                                                                   │             │
│                                                        ┌──────────v───────────┐ │
│                                                        │        Neon          │ │
│                                                        │    (PostgreSQL)      │ │
│                                                        └──────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 11.2 処理フロー

| ステップ | 処理内容 | 制限回避 |
|---------|---------|---------|
| 1. ファイル選択 | クライアント側でヘッダー検出（64KB読み取り） | ✅ サーバー不要 |
| 2. アップロード | Vercel Blob Client Upload（直接アップロード） | ✅ 4.5MB制限回避 |
| 3. キュー登録 | ProductImportLog作成、Inngestイベント発火 | ✅ 即座にレスポンス |
| 4. バックグラウンド処理 | InngestがBlobからCSVを取得、バッチ処理 | ✅ 60秒制限回避 |
| 5. 進捗更新 | ポーリングで進捗確認 | - |

### 11.3 Inngest設定

```typescript
// lib/inngest/client.ts
import { Inngest, EventSchemas } from 'inngest'

type Events = {
  'product/import.requested': {
    data: {
      importLogId: number
      clientId: number
      fileName: string
      blobUrl: string
    }
  }
}

export const inngest = new Inngest({
  id: 'f-gateway',
  name: 'F-Gateway',
  schemas: new EventSchemas().fromRecord<Events>(),
})
```

### 11.4 環境変数

| 変数名 | 説明 | 必須 |
|--------|------|------|
| `INNGEST_EVENT_KEY` | Inngestイベントキー | 本番環境で必須 |
| `INNGEST_SIGNING_KEY` | Inngest署名キー | 本番環境で必須 |
| `BLOB_READ_WRITE_TOKEN` | Vercel Blobトークン | 必須 |

### 11.5 ファイルサイズ制限

| 項目 | 制限値 | 理由 |
|------|--------|------|
| **カラム検出** | 100MB | クライアント側で64KBのみ読み取り |
| **インポート** | 100MB | Vercel Blob制限 |
| **最大行数** | 100,000行 | DB処理パフォーマンス |

---

## 12. 技術スタック

| カテゴリ | 技術 |
|---------|------|
| **CSV解析** | カスタムパーサー（クライアント側 + サーバー側） |
| **ストリーム処理** | Node.js Stream API |
| **文字コード検出** | カスタム実装（UTF-8バイトシーケンス検証） |
| **文字コード変換** | iconv-lite |
| **ファイルストレージ** | Vercel Blob |
| **バックグラウンド処理** | Inngest（プライマリ）/ Vercel Cron（フォールバック） |
| **データベース** | Neon PostgreSQL (JSONB型活用) |
| **暗号化** | crypto (Node.js標準) |

---

## 12. 開発フェーズ

| フェーズ | 内容 | 優先度 |
|---------|------|--------|
| **Phase 1** | 手動CSVアップロード、項目マッピング設定 | 高 |
| **Phase 2** | 巨大CSV対応（ストリーム処理） | 高 |
| **Phase 3** | クライアント側一覧表示・検索 | 高 |
| **Phase 4** | URL自動取得機能 | 中 |
| **Phase 5** | バリデーションルール強化 | 中 |
| **Phase 6** | 変換ルールの高度化 | 低 |

---

## 13. 関連ドキュメント

- [F-Gateway 設計書](./設計書.md)
- [F-Gateway README](./README.md)
- [クライアントID体系](../../IDSystem/02_クライアントID.md)

---

## 更新履歴

| 日付 | 版数 | 更新内容 | 更新者 |
|------|------|---------|--------|
| 2026-01-29 | 1.2 | バックグラウンド処理アーキテクチャ追加（Inngest導入） | Teppei & Claude |
| 2026-01-29 | 1.1 | エンコーディング自動検出機能を追加（5.4節） | Teppei & Claude |
| 2026-01-28 | 1.0 | 初版作成（商品マスタ管理設計） | Teppei & Claude |
