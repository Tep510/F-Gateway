# F-Gateway 設計書

| 項目 | 内容 |
|------|------|
| 文書番号 | DEV-GATEWAY-001 |
| 版数 | 0.6 |
| ステータス | 設計更新完了 |
| 最終更新 | 2026-01-28 |

---

## 1. システム概要

### 1.1 アプリの目的

F-Gateway は、クライアントと Friendslogi 間のデータ交換ポータルです。

#### システムの目的

| 目的 | 説明 |
|------|------|
| **データ交換の自動化** | 手動での CSV アップロード・ダウンロードの手間を削減 |
| **エラーの早期検出** | CSV フォーマット検証により、処理前にエラーを検知 |
| **業務の透明化** | クライアントが自社の作業履歴をリアルタイムで確認可能 |
| **商品マスタの最新化** | 商品マスタの更新頻度を可視化し、データ鮮度を維持 |
| **通知の自動化** | Asana 連携により、エラー・完了を即座に通知 |

### 1.2 クライアントへの提供価値

| 提供価値 | 説明 | 具体的な効果 |
|---------|------|-------------|
| **作業履歴の可視化** | カレンダー形式で過去の作業状況を一目で確認 | 「いつ何をアップロードしたか」を即座に把握 |
| **エラーの即時通知** | CSV エラー時に Asana で即座に通知 | 問題の早期発見・迅速な対応 |
| **Google Drive 連携** | 使い慣れた Google Drive でファイル管理 | 新しいツールの学習コスト不要 |
| **商品マスタの鮮度管理** | 最終更新日を可視化し、更新を促進 | データの陳腐化を防止 |
| **24時間アクセス** | Web ポータルでいつでもどこでも確認可能 | 営業時間外でも作業状況を把握 |

### 1.3 業務効率化のポイント

| ポイント | 従来（手動） | F-Gateway 導入後 |
|---------|------------|-----------------|
| **CSV 検証** | WMS 取込時にエラー発覚 | アップロード直後に検証・即通知 |
| **ファイル転送** | 手動でコピー・リネーム | 検証 OK 時に自動転送・自動リネーム |
| **実績返却** | メール添付 or 手動アップロード | 自動で Google Drive に返却 |
| **作業履歴確認** | 個別にファイル確認 | カレンダー形式で一覧表示 |
| **商品マスタ更新** | 更新漏れが発生しやすい | 更新遅延日数を表示し、定期更新を促進 |
| **エラー対応** | 電話・メールで連絡 | Asana タスクで自動通知 |

### 1.4 システムの位置づけ

### 1.4 システムの位置づけ

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Friendslogi System Architecture                          │
│                    with F-Gateway                                           │
└─────────────────────────────────────────────────────────────────────────────┘

                            [Client Layer]                   # クライアント層
  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐
  │   Client A   │    │   Client B   │    │   Client C   │
  │    (DAQ)     │    │    (MNG)     │    │   (Future)   │
  └──────┬───────┘    └──────┬───────┘    └──────┬───────┘
         │                   │                   │
         │ Google Auth       │                   │
         └───────────────────┼───────────────────┘
                             │
                             v
                      [Gateway Layer]                        # ゲートウェイ層
  ┌──────────────────────────────────────────────────────────────────────────┐
  │                                                                          │
  │                          F-Gateway                                       │
  │                                                                          │
  │   ┌────────────────┐  ┌────────────────┐  ┌────────────────┐            │
  │   │  CSV Upload    │  │   Validator    │  │  File Router   │            │
  │   │  Monitor       │  │                │  │                │            │
  │   └────────────────┘  └────────────────┘  └────────────────┘            │
  │           │                   │                   │                      │
  │           v                   v                   v                      │
  │   ┌────────────────┐  ┌────────────────┐  ┌────────────────┐            │
  │   │ Google Drive   │  │    Asana       │  │ Google Drive   │            │
  │   │ (Client)       │  │  (Project)     │  │ (Friendslogi)  │            │
  │   │                │  │                │  │                │            │
  │   │ - 出庫予定     │  │ - エラー通知   │  │ - 出庫予定     │            │
  │   │ - 出庫実績     │  │ - 完了通知     │  │ - 出庫実績     │            │
  │   │ - 入庫予定     │  │                │  │ - 入庫予定     │            │
  │   │ - 入庫実績     │  │                │  │ - 入庫実績     │            │
  │   │ - 商品マスタ   │  │                │  │ - 商品マスタ   │            │
  │   └────────────────┘  └────────────────┘  └────────────────┘            │
  │                                                                          │
  └──────────────────────────────────────────────────────────────────────────┘
                             │
                             v
                      [Integration Layer]                    # 統合層
  ┌──────────────────────────────────────────────────────────────────────────┐
  │                                                                          │
  │              ┌─────────────────────────┐                                 │
  │              │      WMS Portal         │                                 │
  │              │    (FileMaker Server)   │                                 │
  │              └───────────┬─────────────┘                                 │
  │                          │                                               │
  └──────────────────────────┼───────────────────────────────────────────────┘
                             │
                             v
                         [WMS Layer]                         # WMS層
  ┌──────────────────────────────────────────────────────────────────────────┐
  │              ┌─────────────────────────┐                                 │
  │              │   LogiZard Zero Cloud   │                                 │
  │              └─────────────────────────┘                                 │
  └──────────────────────────────────────────────────────────────────────────┘
```

### 1.5 主要機能

#### 認証・ユーザー管理

| 機能 | 説明 |
|------|------|
| **Google OAuth** | クライアントのGoogleアカウント認証 |
| **クライアント登録** | クライアントIDに基づくクライアント登録 |
| **ユーザー管理** | Admin側でログインユーザーを設定 |
| **ロール管理** | Admin / Client の2ロール |

#### クライアント設定管理

| 機能 | 説明 |
|------|------|
| **Google Drive設定** | クライアントごとに5種類のフォルダを設定 |
| ├ 出庫予定フォルダ | 出庫依頼CSVの提出先 |
| ├ 出庫実績フォルダ | 出庫実績CSVの返却先 |
| ├ 入庫予定フォルダ | 入庫予定CSVの提出先 |
| ├ 入庫実績フォルダ | 入庫実績CSVの返却先 |
| └ 商品マスタフォルダ | 商品マスタCSVの提出先 |
| **Asanaプロジェクト設定** | クライアントごとにAsanaプロジェクトURLを設定 |
| **CSVフォーマット設定** | 文字コード・改行コード・列定義の設定 |

#### CSV受付・検証

| 機能 | 説明 |
|------|------|
| **日次CSV受付** | 1日1ファイルのCSV受付（出庫予定・入庫予定） |
| **フォーマット検証** | 改行コード、文字コード、列構成の検証 |
| **自動転送** | 検証OK時に社内Google Driveへ自動転送 |
| **エラー通知** | 検証エラー時にAsanaへ自動通知 |

#### 商品マスタ管理（重要機能）

F-Gatewayの最重要機能の一つ。詳細は [商品マスタ管理設計書](./商品マスタ管理設計書.md) を参照。

| 機能 | 説明 |
|------|------|
| **柔軟な項目マッピング** | クライアントごとに異なるCSV列定義に対応 |
| **巨大CSV対応** | 数万件規模のCSVをストリーム処理で高速インポート |
| **手動CSVアップロード** | Google Drive経由でCSVを手動アップロード |
| **URL自動取得** | 指定URLから毎日自動で商品マスタを取得 |
| **商品マスタ一覧表示** | クライアントが自社の商品マスタをテーブル形式で閲覧 |
| **検索・フィルタ機能** | 商品コード、商品名、JANコードでの検索 |
| **更新遅延表示** | 最終更新日からの経過日数を表示・色分け |
| **更新促進メッセージ** | 「可能な限り毎日更新してください」と表示 |
| **必須項目管理** | 社内標準の必須項目を定義し、厳密に管理 |
| **バリデーション** | 必須項目チェック、データ型検証 |
| **インポート履歴** | 過去のインポート履歴・エラーログを表示 |

#### 作業履歴・ダッシュボード

| 機能 | 説明 |
|------|------|
| **日次作業履歴** | カレンダー形式で日別の作業状況を表示 |
| **出庫実績返却** | 出庫完了後のCSVをクライアントへ返却（1日1件） |
| **入庫実績返却** | 入庫完了後のCSVをクライアントへ返却（1日1件） |
| **Asana連携** | エラー/完了通知をAsanaプロジェクトへ |

### 1.6 業務モデル

F-Gatewayは**1日1CSV方式**を採用します：

| 項目 | 仕様 |
|------|------|
| **出庫予定** | 1日1ファイルの出庫予定CSVをアップロード |
| **出庫実績** | 1日1ファイルの出庫実績CSVを返却 |
| **入庫予定** | 1日1ファイルの入庫予定CSVをアップロード |
| **入庫実績** | 1日1ファイルの入庫実績CSVを返却 |
| **商品マスタ** | 随時アップロード、可能な限り毎日更新を推奨 |
| **処理タイミング** | リアルタイム監視ではなく、日次バッチ処理を想定 |
| **履歴表示** | カレンダー形式で過去の作業状況を表示 |
| **プロセス表示** | 処理中のステータスは表示しない（完了/エラーのみ） |

---

## 2. 技術スタック

### 2.1 採用技術

| カテゴリ | 技術 | 備考 |
|---------|------|------|
| **フレームワーク** | Next.js 16 | F-LZSync, F-Manual と統一 |
| **言語** | TypeScript | 型安全性確保 |
| **スタイリング** | Tailwind CSS 3.4.17 | v4互換性問題のため3系を使用 |
| **ホスティング** | Vercel | サーバーレス |
| **データベース** | **Neon (PostgreSQL)** | サーバーレスDB、軽量データ向け |
| **認証** | Google OAuth 2.0 | クライアント認証 |
| **外部連携** | Google Drive API | 日次CSVの受付・転送 |
| **外部連携** | Asana API | 通知連携 |
| **開発ポート** | 3002 | ローカル開発環境 |

### 2.2 データベース選定理由（Neon）

| 観点 | F-Gateway の特性 | Neon の適合性 |
|------|-----------------|---------------|
| **データ量** | 設定・ログ程度で少量 | スケールtoゼロで低コスト |
| **アクセスパターン** | CSV受信時のみ（イベント駆動） | サーバーレス向き |
| **必要機能** | 純粋なPostgreSQLで十分 | 余分な機能がない |
| **認証** | Google OAuth（外部） | Supabase Authは不要 |
| **ストレージ** | Google Drive（外部） | Supabase Storageは不要 |

> **Note**: F-LZSyncは大量データ蓄積のためSupabaseを使用。F-Gatewayは軽量なNeonを採用。

### 2.3 Komaki への確認事項

| 項目 | 現在の想定 | 確認ポイント |
|------|-----------|-------------|
| **データベース** | Neon (PostgreSQL) | 適切性 |
| **ファイル監視** | Google Drive API Webhook | 実現方式 |
| **バックグラウンド処理** | Vercel Functions | 処理時間制限 |

---

## 3. ユーザーロール設計

### 3.1 ロール一覧

| ロール | 説明 | 権限 |
|--------|------|------|
| **Admin** | Friendslogi管理者 | 全機能にアクセス可能 |
| **Client** | クライアント担当者 | 自社データのみアクセス可能 |

### 3.2 アクセス制御

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Access Control Design                               │
└─────────────────────────────────────────────────────────────────────────────┘

  [Admin]                                    [Client]
     │                                           │
     │ Login                                     │ Login
     v                                           v
  ┌──────────────────┐                    ┌──────────────────┐
  │ Admin Dashboard  │                    │ Client Dashboard │
  │                  │                    │ (Own data only)  │
  │ - Client Mgmt    │                    │                  │
  │ - User Mgmt      │                    │ - Upload Status  │
  │ - Settings       │                    │ - File List      │
  │ - All Logs       │                    │ - Results        │
  └──────────────────┘                    └──────────────────┘
```

### 3.3 ユーザー管理ポリシー

| ポリシー | 説明 |
|---------|------|
| **ユーザー登録** | Admin側でのみ実施。クライアントは自分でユーザー追加不可 |
| **クライアント紐付け** | 各ユーザーは1つのクライアントに紐付け |
| **ログイン後遷移** | クライアントユーザーはログイン後、自動的に自社ダッシュボードへ |

---

## 4. データモデル設計

### 4.1 テーブル構成

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Neon Database Schema                              │
└─────────────────────────────────────────────────────────────────────────────┘

  ┌─────────────────────────────────────────────────────────────────────────┐
  │                           System Tables                                 │
  │                           # システムテーブル                             │
  ├─────────────────────────────────────────────────────────────────────────┤
  │                                                                         │
  │   ┌─────────────────────┐                                              │
  │   │   system_settings   │                                              │
  │   │  # システム設定      │                                              │
  │   ├─────────────────────┤                                              │
  │   │ id (PK)             │                                              │
  │   │ setting_key         │  # asana_token, etc.                         │
  │   │ setting_value       │  # 暗号化して保存                             │
  │   │ created_at          │                                              │
  │   │ updated_at          │                                              │
  │   └─────────────────────┘                                              │
  │                                                                         │
  └─────────────────────────────────────────────────────────────────────────┘

  ┌─────────────────────────────────────────────────────────────────────────┐
  │                           Master Tables                                 │
  │                           # マスタテーブル                               │
  ├─────────────────────────────────────────────────────────────────────────┤
  │                                                                         │
  │   ┌─────────────────────┐         ┌─────────────────────┐             │
  │   │      clients        │         │       users         │             │
  │   │   # クライアント     │         │   # ユーザー        │             │
  │   ├─────────────────────┤         ├─────────────────────┤             │
  │   │ id (PK)             │<───┐    │ id (PK)             │             │
  │   │ client_code         │    │    │ client_id (FK)      │─────────────┤
  │   │ client_name         │    │    │ google_email        │             │
  │   │ is_active           │    │    │ display_name        │             │
  │   │ created_at          │    │    │ role                │  # admin/client
  │   │ updated_at          │    │    │ is_active           │             │
  │   └─────────────────────┘    │    │ last_login_at       │             │
  │                              │    │ created_at          │             │
  │                              │    │ updated_at          │             │
  │                              │    └─────────────────────┘             │
  │                              │                                         │
  │   ┌─────────────────────┐    │    ┌─────────────────────┐             │
  │   │ client_google_drives│    │    │ client_asana_notify │             │
  │   │ # クライアント別     │    │    │ # Asana通知先設定   │             │
  │   │   Google Drive設定  │    │    ├─────────────────────┤             │
  │   ├─────────────────────┤    └───>│ id (PK)             │             │
  │   │ id (PK)             │         │ client_id (FK)      │             │
  │   │ client_id (FK)      │─────────│ notify_type         │  # upload_error,
  │   │ drive_type          │  # upload/download           │  # upload_success,
  │   │ google_account      │         │ asana_task_gid      │  # result_return
  │   │ folder_id           │         │ asana_task_url      │             │
  │   │ folder_name         │         │ is_active           │             │
  │   │ is_primary          │         │ created_at          │             │
  │   │ is_active           │         │ updated_at          │             │
  │   │ created_at          │         └─────────────────────┘             │
  │   │ updated_at          │                                              │
  │   └─────────────────────┘                                              │
  │                                                                         │
  │   ┌─────────────────────┐                                              │
  │   │   csv_formats       │                                              │
  │   │  # CSVフォーマット   │                                              │
  │   ├─────────────────────┤                                              │
  │   │ id (PK)             │                                              │
  │   │ client_id (FK)      │                                              │
  │   │ format_type         │  # shipping_request, item_master             │
  │   │ encoding            │  # UTF-8, Shift_JIS                          │
  │   │ line_ending         │  # CRLF, LF                                  │
  │   │ columns_definition  │  # JSON                                      │
  │   │ created_at          │                                              │
  │   │ updated_at          │                                              │
  │   └─────────────────────┘                                              │
  │                                                                         │
  └─────────────────────────────────────────────────────────────────────────┘

  ┌─────────────────────────────────────────────────────────────────────────┐
  │                        Transaction Tables                               │
  │                        # トランザクションテーブル                        │
  ├─────────────────────────────────────────────────────────────────────────┤
  │                                                                         │
  │   ┌─────────────────────┐         ┌─────────────────────┐             │
  │   │   csv_upload_logs   │         │  file_transfers     │             │
  │   │  # CSV提出ログ       │         │  # ファイル転送     │             │
  │   ├─────────────────────┤         ├─────────────────────┤             │
  │   │ id (PK)             │<───────>│ id (PK)             │             │
  │   │ client_id (FK)      │         │ upload_log_id (FK)  │             │
  │   │ work_date           │         │ source_path         │             │
  │   │ csv_type            │         │ dest_path           │             │
  │   │ google_drive_id(FK) │         │ renamed_name        │             │
  │   │ file_name           │         │ transfer_status     │             │
  │   │ file_size           │         │ transferred_at      │             │
  │   │ upload_time         │         │ created_at          │             │
  │   │ validation_status   │         └─────────────────────┘             │
  │   │ validation_errors   │                                              │
  │   │ processed_at        │                                              │
  │   │ created_at          │                                              │
  │   └─────────────────────┘                                              │
  │                                                                         │
  │   ┌─────────────────────┐         ┌─────────────────────┐             │
  │   │  result_returns     │         │ item_master_logs    │             │
  │   │  # 実績返却          │         │  # 商品マスタ管理   │             │
  │   ├─────────────────────┤         ├─────────────────────┤             │
  │   │ id (PK)             │         │ id (PK)             │             │
  │   │ client_id (FK)      │         │ client_id (FK)      │             │
  │   │ result_type         │         │ upload_log_id (FK)  │             │
  │   │ result_file_name    │         │ item_code           │             │
  │   │ record_count        │         │ item_name           │             │
  │   │ return_status       │         │ jan_code            │             │
  │   │ returned_at         │         │ last_updated_at     │             │
  │   │ created_at          │         │ created_at          │             │
  │   └─────────────────────┘         └─────────────────────┘             │
  │                                                                         │
  │   ┌─────────────────────┐                                              │
  │   │ asana_notifications │                                              │
  │   │  # Asana通知ログ    │                                              │
  │   ├─────────────────────┤                                              │
  │   │ id (PK)             │                                              │
  │   │ client_id (FK)      │                                              │
  │   │ notification_type   │                                              │
  │   │ message             │                                              │
  │   │ asana_task_gid      │                                              │
  │   │ asana_response      │                                              │
  │   │ sent_at             │                                              │
  │   │ created_at          │                                              │
  │   └─────────────────────┘                                              │
  │                                                                         │
  └─────────────────────────────────────────────────────────────────────────┘
```

### 4.2 テーブル詳細

#### system_settings（システム設定）

| カラム | 型 | 説明 |
|--------|-----|------|
| id | uuid | 主キー |
| setting_key | varchar(50) | 設定キー（asana_api_token等） |
| setting_value | text | 設定値（暗号化して保存） |
| created_at | timestamp | 作成日時 |
| updated_at | timestamp | 更新日時 |

#### clients（クライアント）

| カラム | 型 | 説明 |
|--------|-----|------|
| id | uuid | 主キー |
| client_code | varchar(3) | クライアントコード（DAQ, MNG等）**ID体系準拠** |
| client_name | varchar(100) | クライアント名 |
| is_active | boolean | 有効フラグ |
| created_at | timestamp | 作成日時 |
| updated_at | timestamp | 更新日時 |

#### users（ユーザー）

| カラム | 型 | 説明 |
|--------|-----|------|
| id | uuid | 主キー |
| client_id | uuid | クライアントID（FK）※Adminはnull |
| google_email | varchar(255) | Googleアカウント |
| display_name | varchar(100) | 表示名 |
| role | varchar(20) | ロール（admin / client） |
| is_active | boolean | 有効フラグ |
| last_login_at | timestamp | 最終ログイン日時 |
| created_at | timestamp | 作成日時 |
| updated_at | timestamp | 更新日時 |

#### client_google_drives（クライアント別Google Drive設定）

| カラム | 型 | 説明 |
|--------|-----|------|
| id | uuid | 主キー |
| client_id | uuid | クライアントID（FK） |
| drive_type | varchar(30) | 用途（shipping_plan, shipping_result, receiving_plan, receiving_result, item_master） |
| google_account | varchar(255) | Googleアカウント |
| folder_id | varchar(100) | Google Drive Folder ID |
| folder_name | varchar(255) | フォルダ表示名 |
| is_active | boolean | 有効フラグ |
| created_at | timestamp | 作成日時 |
| updated_at | timestamp | 更新日時 |

**drive_type 定義**:

| drive_type | 日本語名 | 説明 |
|-----------|---------|------|
| `shipping_plan` | 出庫予定 | クライアントが出庫依頼CSVをアップロードするフォルダ |
| `shipping_result` | 出庫実績 | Friendslogiが出庫実績CSVを返却するフォルダ |
| `receiving_plan` | 入庫予定 | クライアントが入庫予定CSVをアップロードするフォルダ |
| `receiving_result` | 入庫実績 | Friendslogiが入庫実績CSVを返却するフォルダ |
| `item_master` | 商品マスタ | クライアントが商品マスタCSVをアップロードするフォルダ |

> **Note**: 用語規則 - WMSポータルの命名規則に従い、「出庫」「入庫」を使用

#### client_asana_settings（クライアント別Asana設定）

| カラム | 型 | 説明 |
|--------|-----|------|
| id | uuid | 主キー |
| client_id | uuid | クライアントID（FK） |
| asana_project_url | varchar(500) | AsanaプロジェクトURL |
| asana_project_gid | varchar(50) | AsanaプロジェクトGID（URLから抽出） |
| is_active | boolean | 有効フラグ |
| created_at | timestamp | 作成日時 |
| updated_at | timestamp | 更新日時 |

> **Note**: タスク単位ではなく、プロジェクト単位で通知先を設定。エラー・完了はプロジェクト内に新規タスクを作成して通知。

#### csv_upload_logs（CSV提出ログ）

| カラム | 型 | 説明 |
|--------|-----|------|
| id | uuid | 主キー |
| client_id | uuid | クライアントID（FK） |
| work_date | date | 作業日（1日1レコード） |
| csv_type | varchar(30) | CSV種別（shipping_plan, receiving_plan, item_master） |
| google_drive_id | uuid | 使用したGoogle Drive設定（FK） |
| file_name | varchar(255) | ファイル名 |
| file_size | bigint | ファイルサイズ（bytes） |
| upload_time | timestamp | アップロード日時 |
| validation_status | varchar(20) | 検証ステータス（valid, invalid） |
| validation_errors | jsonb | 検証エラー詳細（JSON） |
| processed_at | timestamp | 処理完了日時 |
| created_at | timestamp | 作成日時 |

> **Note**: 1日1CSV方式のため、work_dateで日次管理。処理中ステータス（pending）は使用しない。

#### item_master_logs（商品マスタ管理）

| カラム | 型 | 説明 |
|--------|-----|------|
| id | uuid | 主キー |
| client_id | uuid | クライアントID（FK） |
| upload_log_id | uuid | CSV提出ログID（FK） |
| item_code | varchar(50) | 商品コード |
| item_name | varchar(255) | 商品名 |
| jan_code | varchar(13) | JANコード |
| last_updated_at | timestamp | 最終更新日時 |
| created_at | timestamp | 作成日時 |

**商品マスタ更新遅延の表示ルール**:

| 経過日数 | 表示 |
|---------|------|
| 0-1日 | 緑色「最新」 |
| 2-6日 | 黄色「○日前に更新」 |
| 7日以上 | 赤色「警告：○日間更新なし」 |

**更新促進メッセージ**:
> 「商品マスタは可能な限り毎日更新してください。在庫情報の精度向上につながります。」

---

## 5. 業務フロー設計

### 5.1 出荷依頼CSV受付フロー

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Shipping Request CSV Flow                                │
│                    # 出荷依頼CSV受付フロー                                   │
└─────────────────────────────────────────────────────────────────────────────┘

  [Client]                                              [F-Gateway]

  (1) Upload CSV
      │
      v
  ┌──────────────┐
  │ Client's     │
  │ Google Drive │
  └──────┬───────┘
         │
         │ (2) Detect Upload (Webhook)
         v
                                                  ┌──────────────┐
                                                  │ File Monitor │
                                                  └──────┬───────┘
                                                         │
                                                         │ (3) Download & Log
                                                         v
                                                  ┌──────────────┐
                                                  │  Validator   │
                                                  └──────┬───────┘
                                                         │
                              ┌───────────────────────────┴───────────────────┐
                              │                                               │
                              v                                               v
                       [Validation NG]                                 [Validation OK]
                              │                                               │
                              v                                               v
                       ┌──────────────┐                                ┌──────────────┐
                       │    Asana     │                                │   Rename &   │
                       │ Error Notify │                                │    Copy      │
                       │ (Task GID)   │                                └──────┬───────┘
                       └──────────────┘                                       │
                                                                              v
                                                                       ┌──────────────┐
                                                                       │ Friendslogi  │
                                                                       │ Google Drive │
                                                                       └──────────────┘
```

### 5.2 出荷実績返却フロー

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Shipment Result Return Flow                              │
│                    # 出荷実績返却フロー                                      │
└─────────────────────────────────────────────────────────────────────────────┘

  [WMS Portal]                [F-Gateway]                    [Client]

  (1) Shipment Complete
      │
      v
  ┌──────────────┐
  │ Export CSV   │
  │ (Result)     │
  └──────┬───────┘
         │
         │ (2) Trigger
         v
                                                  ┌──────────────┐
                                                  │ Result       │
                                                  │ Processor    │
                                                  └──────┬───────┘
                                                         │
                                                         │ (3) Format &
                                                         │     Copy
                                                         v
                              ┌───────────────────────────┴───────────────────┐
                              │                                               │
                              v                                               v
                       ┌──────────────┐                                ┌──────────────┐
                       │    Asana     │                                │ Client's     │
                       │ Notify       │                                │ Google Drive │
                       │ (Task GID)   │                                └──────────────┘
                       └──────────────┘                                       │
                              │ (4) Notify Complete                           │
                              v                                               v
                       ┌──────────────┐                                ┌──────────────┐
                       │   Client     │<---------- Download -----------│    CSV       │
                       └──────────────┘            (5) Get Result      └──────────────┘
```

---

## 6. Asana通知設計

### 6.1 通知先設定仕様

| 設定項目 | 形式 | 例 | 説明 |
|---------|------|-----|------|
| **AsanaプロジェクトURL** | URL | `https://app.asana.com/0/123456789/list` | プロジェクトのURL |
| **AsanaプロジェクトGID** | 数字文字列 | `123456789` | APIで使用するプロジェクトID |

### 6.2 通知種別

| 通知種別 | タイミング | 通知内容 |
|---------|----------|---------|
| **CSV検証エラー** | CSVアップロード時、検証エラー発生時 | ファイル名、エラー詳細、エラー行番号 |
| **CSV処理完了** | CSV検証成功、社内転送完了時 | ファイル名、処理件数、転送先 |
| **実績返却完了** | 出庫実績・入庫実績の返却完了時 | ファイル名、件数、返却先フォルダ |
| **商品マスタ更新** | 商品マスタCSVアップロード時 | 更新件数、新規件数、削除件数 |

### 6.3 通知方法

F-Gatewayは、指定されたAsanaプロジェクト内に**新規タスクを作成**して通知します。

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Asana Notification Flow                                  │
└─────────────────────────────────────────────────────────────────────────────┘

  [F-Gateway]                      [Asana Project]

  (1) Event Occurs
      │
      │ CSV Error / Success / Result Return
      v
  ┌──────────────────┐
  │ Format Message   │
  └────────┬─────────┘
           │
           v
  ┌──────────────────┐
  │ POST /tasks      │
  │                  │
  │ - project_gid    │
  │ - name           │
  │ - notes          │
  └────────┬─────────┘
           │
           v
  ┌──────────────────────────────────────┐
  │ Asana Project                        │
  │                                      │
  │ [New Task Created]                   │
  │  - CSVエラー通知                      │
  │  - ファイル: shipping_20260128.csv   │
  │  - エラー: 列数不一致                │
  └──────────────────────────────────────┘
```

### 6.4 プロジェクトURL/GIDの登録仕様

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Asana Project Registration Flow                          │
└─────────────────────────────────────────────────────────────────────────────┘

  [Admin Input]                      [F-Gateway]

  Enter Project URL:
  https://app.asana.com/0/123456789/list
      │
      │ (1) Parse URL
      v
  ┌──────────────────┐
  │ Extract GID      │
  │ from URL         │
  └────────┬─────────┘
           │
           v
  ┌──────────────────┐
  │ GET /projects/{gid}
  │ (Validate)       │
  └────────┬─────────┘
           │
           v
  Store: project_gid = "123456789"
         project_url = "https://app.asana.com/0/123456789/list"
```

### 6.4 Asana APIトークン管理

| 項目 | 内容 |
|------|------|
| **保存場所** | system_settings テーブル（暗号化） |
| **設定画面** | Admin > Settings > Asana Integration |
| **権限** | Adminのみ設定可能 |
| **トークン種別** | Personal Access Token (PAT) |

---

## 7. 画面設計

### 7.1 画面一覧

#### Admin画面

| 画面 | パス | 説明 |
|------|------|------|
| Adminダッシュボード | `/admin` | 全体概況、最新アップロード |
| クライアント管理 | `/admin/clients` | クライアント一覧・登録・編集 |
| クライアント詳細 | `/admin/clients/[id]` | クライアント設定詳細 |
| ユーザー管理 | `/admin/users` | ユーザー一覧・登録・編集 |
| アップロードログ | `/admin/logs` | 全クライアントのCSV提出ログ |
| システム設定 | `/admin/settings` | Asanaトークン等の設定 |

#### Client画面

| 画面 | パス | 説明 |
|------|------|------|
| トップ（ログイン選択） | `/` | Admin/Clientログイン選択 |
| クライアントダッシュボード | `/client` | 日次カレンダー形式の作業履歴 |
| 出庫管理 | `/client/shipping` | 出庫予定・出庫実績の履歴 |
| 入庫管理 | `/client/receiving` | 入庫予定・入庫実績の履歴 |
| 商品マスタ | `/client/items` | 自社の商品マスタ一覧・更新状況 |

> **Note**: 全画面日本語UIで統一。処理プロセスを見せず、結果のみ表示する設計。

### 7.2 クライアントダッシュボード（実装版）

**コンセプト**: カレンダー形式で日次の作業履歴を表示。処理プロセスは見せず、結果のみ表示。

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  F-Gateway                        [DAQ]   goto@daq.jp      [Logout]        │
├────────┬────────────────────────────────────────────────────────────────────┤
│        │                                                                    │
│ Menu   │  Dashboard                                                         │
│        │  T-shirts.sc                                                       │
│ [Dashboard]                                                                 │
│ [Shipping]  ┌─── Monthly Summary ──────────────────────────────────────┐   │
│ [Receiving] │                                                          │   │
│ [Items]     │  This Month: 28 days   Success: 27 days   Error: 1 day  │   │
│        │    │                                                          │   │
│        │    └──────────────────────────────────────────────────────────┘   │
│        │                                                                    │
│        │    ┌─── Item Master Status ───────────────────────────────────┐   │
│        │    │                                                          │   │
│        │    │  Last Update: 2026-01-27  (1 day ago)  [Green OK]       │   │
│        │    │                                                          │   │
│        │    │  推奨: 商品マスタは可能な限り毎日更新してください        │   │
│        │    │                                                          │   │
│        │    │  [View Item Master ->]                                   │   │
│        │    │                                                          │   │
│        │    └──────────────────────────────────────────────────────────┘   │
│        │                                                                    │
│        │    ┌─── 2026-01 Work History ───────────────────────────────┐     │
│        │    │                                                         │     │
│        │    │  Date   Day  Shipping  Receiving  Shipment  Arrival    │     │
│        │    │              Plan      Plan       Result    Result     │     │
│        │    │  ───────────────────────────────────────────────────────│     │
│        │    │  1/28   Tue  [OK]      [OK]       [OK]      [OK]       │     │
│        │    │  1/27   Mon  [OK]      [OK]       [OK]      [OK]       │     │
│        │    │  1/26   Sun  [OK]      -          [OK]      -          │     │
│        │    │  1/25   Sat  [OK]      -          [OK]      -          │     │
│        │    │  1/24   Fri  [OK]      [OK]       [OK]      [OK]       │     │
│        │    │  1/23   Thu  [OK]      -          [OK]      -          │     │
│        │    │  1/22   Wed  [OK]      [OK]       [OK]      [OK]       │     │
│        │    │  1/21   Tue  [OK]      -          [OK]      -          │     │
│        │    │  1/20   Mon  [OK]      [OK]       [OK]      [OK]       │     │
│        │    │  1/19   Sun  [ERROR]   -          -         -          │     │
│        │    │                       Error: Column count mismatch      │     │
│        │    │  ...                                                    │     │
│        │    │                                                         │     │
│        │    └─────────────────────────────────────────────────────────┘     │
│        │                                                                    │
│        │    [Open Google Drive]                                            │
│        │                                                                    │
└────────┴────────────────────────────────────────────────────────────────────┘
```

**特徴**:
- 1日1行で表示（出庫予定・入庫予定・出庫実績・入庫実績）
- 商品マスタの更新状況を可視化
- 更新遅延日数に応じて色分け（緑・黄・赤）
- 土日は背景色でハイライト
- 処理中ステータスは非表示
- 過去の履歴をスクロールで閲覧可能

### 7.3 商品マスタ画面（Client）

**コンセプト**: 自社の商品マスタを一覧表示。更新遅延を可視化し、定期更新を促進。

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  F-Gateway > Item Master              [DAQ]   goto@daq.jp      [Logout]   │
├────────┬────────────────────────────────────────────────────────────────────┤
│        │                                                                    │
│ Menu   │  Item Master                                                       │
│        │  T-shirts.sc                                                       │
│ [Dashboard]                                                                 │
│ [Shipping]  ┌─── Update Status ────────────────────────────────────────┐   │
│ [Receiving] │                                                          │   │
│ [Items]     │  Last Update: 2026-01-27 14:30  (1 day ago)  [Green OK] │   │
│        │    │                                                          │   │
│        │    │  推奨: 商品マスタは可能な限り毎日更新してください        │   │
│        │    │  在庫情報の精度向上につながります。                      │   │
│        │    │                                                          │   │
│        │    │  [Upload New Master]  [Download Template]               │   │
│        │    │                                                          │   │
│        │    └──────────────────────────────────────────────────────────┘   │
│        │                                                                    │
│        │    ┌─── Item Master List ─────────────────────────────────────┐   │
│        │    │                                                          │   │
│        │    │  Total: 1,234 items                                      │   │
│        │    │                                                          │   │
│        │    │  Code      Name              JAN           Updated      │   │
│        │    │  ──────────────────────────────────────────────────────  │   │
│        │    │  DAQ-001   T-Shirt White S   4901234567890  1 day ago   │   │
│        │    │  DAQ-002   T-Shirt White M   4901234567891  1 day ago   │   │
│        │    │  DAQ-003   T-Shirt White L   4901234567892  1 day ago   │   │
│        │    │  DAQ-004   T-Shirt Black S   4901234567893  5 days ago  │   │
│        │    │  DAQ-005   T-Shirt Black M   4901234567894  8 days ago  │   │
│        │    │              [Warning: 7+ days]           [Red Alert]   │   │
│        │    │  ...                                                     │   │
│        │    │                                                          │   │
│        │    │                                        [Next Page ->]    │   │
│        │    └──────────────────────────────────────────────────────────┘   │
│        │                                                                    │
└────────┴────────────────────────────────────────────────────────────────────┘
```

**特徴**:
- 最終更新日時を表示
- 更新遅延日数に応じて色分け
  - 0-1日: 緑色「最新」
  - 2-6日: 黄色「○日前に更新」
  - 7日以上: 赤色「警告：○日間更新なし」
- 更新促進メッセージを常に表示
- CSV形式でのアップロード・ダウンロード機能

### 7.4 Adminダッシュボード（実装版）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  F-Gateway                        Admin: goto@daq.jp        [Logout]       │
├────────┬────────────────────────────────────────────────────────────────────┤
│        │                                                                    │
│ Menu   │  Dashboard                                                         │
│        │  System Overview                                                   │
│ [Dashboard]                                                                 │
│ [Clients]  ┌─── System Status ─────────────────────────────────────────┐   │
│ [Users]    │                                                           │   │
│ [Logs]     │  Active Clients: 3   Today Upload: 3   Today Ship: 2     │   │
│ [Settings] │  Today Error: 0                                           │   │
│        │   │                                                           │   │
│        │   └───────────────────────────────────────────────────────────┘   │
│        │                                                                    │
│        │   ┌─── Recent Activity ───────────────────────────────────────┐   │
│        │   │                                                           │   │
│        │   │  Date       Time   Client  Type          Status           │   │
│        │   │  ─────────────────────────────────────────────────────────│   │
│        │   │  2026-01-28 14:32  DAQ     Upload        [OK]             │   │
│        │   │  2026-01-28 14:25  MNG     Upload        [OK]             │   │
│        │   │  2026-01-28 10:15  DAQ     Shipment      [OK]             │   │
│        │   │  2026-01-28 09:45  OSN     Upload        [OK]             │   │
│        │   │  2026-01-28 09:30  MNG     Shipment      [OK]             │   │
│        │   │                                                           │   │
│        │   └───────────────────────────────────────────────────────────┘   │
│        │                                                                    │
│        │   ┌─── Today Client Status ───────────────────────────────────┐   │
│        │   │                                                           │   │
│        │   │  Code  Name          Upload    Shipment   Last Activity   │   │
│        │   │  ─────────────────────────────────────────────────────────│   │
│        │   │  DAQ   T-shirts.sc   [OK]      [OK]       14:32           │   │
│        │   │  MNG   Morinogakkou  [OK]      [OK]       14:25           │   │
│        │   │  OSN   Oson Stock    [OK]      -          09:45           │   │
│        │   │                                                           │   │
│        │   └───────────────────────────────────────────────────────────┘   │
│        │                                                                    │
└────────┴────────────────────────────────────────────────────────────────────┘
```

### 7.5 クライアント管理画面（Admin）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  F-Gateway Admin > Clients > DAQ             [Admin: goto@daq.jp] [Logout] │
├───────────────┬─────────────────────────────────────────────────────────────┤
│               │                                                             │
│  NAVIGATION   │  クライアント編集: DAQ                                      │
│               │                                                             │
│  [Dashboard]  │  ┌─── 基本情報 ──────────────────────────────────────────┐  │
│  [Clients]    │  │                                                       │  │
│    > DAQ      │  │  クライアントコード: [DAQ        ] (3文字、大文字)     │  │
│    > MNG      │  │  クライアント名:     [T-shirts.sc               ]     │  │
│    > OSN      │  │  ステータス:         [x] 有効                         │  │
│  [Users]      │  │                                                       │  │
│  [Logs]       │  └───────────────────────────────────────────────────────┘  │
│  [Settings]   │                                                             │
│               │  ┌─── Google Drive 設定 ─────────────────────────────────┐  │
│               │  │                                                       │  │
│               │  │  出庫予定フォルダ:                                     │  │
│               │  │  [x] daq-shipping@gmail.com                           │  │
│               │  │      Folder ID: [1ABC...xyz        ]  [Test] [Remove] │  │
│               │  │                                                       │  │
│               │  │  出庫実績フォルダ:                                     │  │
│               │  │  [x] daq-shipping@gmail.com                           │  │
│               │  │      Folder ID: [2DEF...uvw        ]  [Test] [Remove] │  │
│               │  │                                                       │  │
│               │  │  入庫予定フォルダ:                                     │  │
│               │  │  [x] daq-receiving@gmail.com                          │  │
│               │  │      Folder ID: [3GHI...rst        ]  [Test] [Remove] │  │
│               │  │                                                       │  │
│               │  │  入庫実績フォルダ:                                     │  │
│               │  │  [x] daq-receiving@gmail.com                          │  │
│               │  │      Folder ID: [4JKL...opq        ]  [Test] [Remove] │  │
│               │  │                                                       │  │
│               │  │  商品マスタフォルダ:                                   │  │
│               │  │  [x] daq-master@gmail.com                             │  │
│               │  │      Folder ID: [5MNO...lmn        ]  [Test] [Remove] │  │
│               │  │                                                       │  │
│               │  └───────────────────────────────────────────────────────┘  │
│               │                                                             │
│               │  ┌─── Asana 連携設定 ────────────────────────────────────┐  │
│               │  │                                                       │  │
│               │  │  Asanaプロジェクト:                                    │  │
│               │  │  Project URL: [https://app.asana.com/0/123456789  ]   │  │
│               │  │  Project GID: [123456789          ] (auto-filled)     │  │
│               │  │  [x] 有効                              [Test Notify]  │  │
│               │  │                                                       │  │
│               │  │  通知タイミング:                                       │  │
│               │  │  [x] CSV検証エラー時                                   │  │
│               │  │  [x] CSV処理完了時                                     │  │
│               │  │  [x] 実績返却完了時                                    │  │
│               │  │                                                       │  │
│               │  └───────────────────────────────────────────────────────┘  │
│               │                                                             │
│               │  ┌─── CSV フォーマット設定 ──────────────────────────────┐  │
│               │  │                                                       │  │
│               │  │  文字コード:   [UTF-8       ▼]                         │  │
│               │  │  改行コード:   [CRLF        ▼]                         │  │
│               │  │                                                       │  │
│               │  │  列定義: [列定義を設定 ->]                             │  │
│               │  │                                                       │  │
│               │  └───────────────────────────────────────────────────────┘  │
│               │                                                             │
│               │                              [キャンセル]  [変更を保存]    │
│               │                                                             │
└───────────────┴─────────────────────────────────────────────────────────────┘
```

**特徴**:
- 全ラベル日本語化
- Google Drive設定を5種類に拡張（出庫予定・出庫実績・入庫予定・入庫実績・商品マスタ）
- Asanaはプロジェクト単位で設定
- 通知タイミングをチェックボックスで選択

### 7.6 デザインコンセプト

F-Gatewayのデザインは、**現代風でモダンなUIでありながら、落ち着いて信頼感のある業務アプリデザイン**を目指します。

#### 基本方針

| 項目 | 方針 | 具体例 |
|------|------|--------|
| **色使い** | 落ち着いた配色、信頼感のある色調 | 青（#3498db）、緑（#27ae60）、グレー（#2c3e50） |
| **タイポグラフィ** | 読みやすさ重視、日本語フォント最適化 | Noto Sans JP、Hiragino Kaku Gothic ProN |
| **レイアウト** | シンプルで見通しが良い構成 | カード型レイアウト、適切な余白 |
| **アイコン** | シンプルでわかりやすいアイコン | Heroicons、線の細いミニマルなスタイル |
| **インタラクション** | スムーズで直感的 | ホバーエフェクト、トランジション |

#### 配色設計

```
Primary Colors:
  Blue:   #3498db (信頼感、冷静さ)
  Green:  #27ae60 (成功、完了)
  Red:    #e74c3c (エラー、警告)
  Yellow: #f39c12 (注意、遅延)

Neutral Colors:
  Gray-900: #2c3e50 (テキスト)
  Gray-700: #34495e (サブテキスト)
  Gray-300: #dfe6e9 (ボーダー)
  Gray-50:  #f8f9fa (背景)
  White:    #ffffff (カード背景)
```

#### UI要素

| 要素 | デザイン |
|------|---------|
| **ボタン** | 角丸、ソフトシャドウ、ホバーで色変化 |
| **カード** | 白背景、subtle shadow、角丸 |
| **テーブル** | ストライプなし、ホバーで行を強調 |
| **バッジ** | 色分け（成功・エラー・警告）、角丸 |
| **アイコン** | 各メニューに適切なアイコンを付与 |

#### メニューアイコン

| メニュー | アイコン | 説明 |
|---------|---------|------|
| ダッシュボード | 📊 | グラフアイコン |
| 出庫管理 | 📦 | 箱アイコン |
| 入庫管理 | 📥 | 入荷アイコン |
| 商品マスタ | 🏷️ | タグアイコン |
| クライアント管理 | 👥 | ユーザーグループアイコン |
| ユーザー管理 | 👤 | ユーザーアイコン |
| ログ | 📄 | ドキュメントアイコン |
| 設定 | ⚙️ | 設定アイコン |

#### レスポンシブ対応

| デバイス | 対応 |
|---------|------|
| PC | 優先、1280px以上を想定 |
| タブレット | 対応、サイドバーは折りたたみ |
| スマートフォン | 基本対応、縦スクロール重視 |

### 7.7 システム設定画面（Admin）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  F-Gateway Admin > Settings                  [Admin: goto@daq.jp] [Logout] │
├───────────────┬─────────────────────────────────────────────────────────────┤
│               │                                                             │
│  NAVIGATION   │  System Settings                                           │
│               │                                                             │
│  [Dashboard]  │  ┌─── Asana Integration ─────────────────────────────────┐  │
│  [Clients]    │  │                                                       │  │
│  [Users]      │  │  Asana API Token:                                     │  │
│  [Logs]       │  │  [********************************] [Show/Hide]       │  │
│  [Settings]   │  │                                                       │  │
│    > Asana    │  │  Token Status: [Connected]  Last verified: 2026-01-26│  │
│    > Google   │  │                                                       │  │
│               │  │  [Test Connection]  [Update Token]                    │  │
│               │  │                                                       │  │
│               │  │  ─────────────────────────────────────────────────────│  │
│               │  │                                                       │  │
│               │  │  How to get Asana API Token:                          │  │
│               │  │  1. Go to Asana > My Settings > Apps > Developer apps │  │
│               │  │  2. Create a Personal Access Token                    │  │
│               │  │  3. Copy and paste the token above                    │  │
│               │  │                                                       │  │
│               │  └───────────────────────────────────────────────────────┘  │
│               │                                                             │
│               │  ┌─── Google Drive Integration ──────────────────────────┐  │
│               │  │                                                       │  │
│               │  │  Friendslogi Service Account:                         │  │
│               │  │  gateway@friendslogi.iam.gserviceaccount.com          │  │
│               │  │                                                       │  │
│               │  │  Status: [Connected]                                  │  │
│               │  │                                                       │  │
│               │  │  Note: Client Google Drive access is configured       │  │
│               │  │  per-client in the client settings.                   │  │
│               │  │                                                       │  │
│               │  └───────────────────────────────────────────────────────┘  │
│               │                                                             │
└───────────────┴─────────────────────────────────────────────────────────────┘
```

---

## 8. 外部連携設計

### 8.1 Google Drive API

| 機能 | API | 説明 |
|------|-----|------|
| ファイル監視 | Changes API + Webhook | フォルダ内の変更を監視 |
| ファイル一覧 | Files.list | フォルダ内ファイルの一覧取得 |
| ファイル取得 | Files.get | CSVファイルのダウンロード |
| ファイルコピー | Files.copy | 別フォルダへのコピー |
| メタデータ更新 | Files.update | ファイル名変更 |

### 8.2 Asana API

| 機能 | API | 説明 |
|------|-----|------|
| タスク取得 | GET /tasks/{gid} | タスク存在確認・情報取得 |
| コメント追加 | POST /tasks/{gid}/stories | タスクへの通知コメント追加 |

### 8.3 Asana通知フォーマット

```
【F-Gateway】CSVアップロードエラー

クライアント: DAQ (T-shirts.sc)
ファイル名: shipping_20260126.csv
アップロード日時: 2026-01-26 14:30:25

エラー内容:
- 列数が不正です（期待: 15, 実際: 14）
- 行5: 必須項目「商品コード」が空です

対応をお願いします。
```

---

## 9. CSV検証仕様

### 9.1 検証項目

| 検証項目 | 詳細 | エラー時の対応 |
|---------|------|---------------|
| **文字コード** | UTF-8 または Shift_JIS（クライアント設定による） | Asana通知 |
| **改行コード** | CRLF または LF（クライアント設定による） | Asana通知 |
| **列数** | 定義された列数と一致するか | Asana通知 |
| **列名** | ヘッダー行の列名が一致するか | Asana通知 |
| **必須項目** | 必須列に値が入っているか | Asana通知 |
| **データ型** | 数値項目に数値が入っているか等 | Asana通知 |

### 9.2 ファイルリネーム規則

検証OK時のリネーム規則：

```
[クライアントコード]_[ファイル種別]_[日付]_[連番].csv

例:
  DAQ_shipping_20260126_001.csv
  MNG_item_master_20260126_001.csv
```

---

## 10. 非機能要件

### 10.1 性能要件

| 項目 | 要件 |
|------|------|
| ファイル検知 | アップロードから5分以内に検知 |
| CSV検証 | 1ファイル30秒以内 |
| 転送処理 | 検証OKから5分以内に転送完了 |
| 同時処理 | 複数クライアントの同時処理対応 |

### 10.2 可用性要件

| 項目 | 要件 |
|------|------|
| 稼働時間 | 24時間365日 |
| 障害復旧 | 自動リトライ（最大3回） |
| 通知 | 処理失敗時にAsana通知 |

### 10.3 セキュリティ要件

| 項目 | 要件 |
|------|------|
| 認証 | Google OAuth 2.0 |
| 認可 | クライアントは自社データのみアクセス可 |
| API認証 | Google/Asana APIキーは環境変数で管理 |
| トークン保存 | Asanaトークンは暗号化して保存 |
| データ保護 | CSVファイルは処理後に削除（ログのみ保持） |

---

## 11. 開発フェーズ

### 11.1 フェーズ分割

| フェーズ | 内容 | 優先度 |
|---------|------|--------|
| **Phase 1** | 基盤構築・認証・ロール管理 | 高 |
| **Phase 2** | クライアント管理・ユーザー管理（Admin） | 高 |
| **Phase 3** | Google Drive連携（監視・一覧・転送） | 高 |
| **Phase 4** | CSV受付・フォーマット検証・ログ蓄積 | 高 |
| **Phase 5** | Asana連携（トークン設定・通知） | 中 |
| **Phase 6** | クライアントダッシュボード | 中 |
| **Phase 7** | 出荷実績返却機能 | 中 |

### 11.2 Phase 1 詳細

1. プロジェクト初期構築（Next.js + TypeScript）
2. Neon接続・テーブル作成
3. Google OAuth認証実装
4. ロール判定・画面振り分け（Admin / Client）
5. 基本画面（ログイン、ダッシュボード骨格）

---

## 12. モックアップ実装状況

### 12.1 実装完了項目

| 項目 | 状態 | パス |
|------|------|------|
| プロジェクト初期化 | ✅ 完了 | `/Users/tep/Projects/Friednslogi/Development/F-Gateway/web/` |
| Next.js 16 + TypeScript | ✅ 完了 | App Router方式 |
| Tailwind CSS 3.4.17 | ✅ 完了 | ダウングレード対応済み |
| トップページ | ✅ 完了 | `/app/page.tsx` |
| Client Dashboard | ✅ 完了 | `/app/client/page.tsx` |
| Admin Dashboard | ✅ 完了 | `/app/admin/page.tsx` |
| Header Component | ✅ 完了 | `/app/components/Header.tsx` |
| Sidebar Component | ✅ 完了 | `/app/components/Sidebar.tsx` |
| 日次履歴カレンダーUI | ✅ 完了 | Client Dashboard内 |
| 業務アプリ配色 | ✅ 完了 | `globals.css` |

### 12.2 モックアップの特徴

| 特徴 | 説明 |
|------|------|
| **1日1CSV方式** | 1日につき1アップロード・1出荷実績の表示 |
| **カレンダー形式** | 日別の作業履歴をテーブル形式で表示 |
| **プロセス非表示** | 処理中ステータスは表示せず、完了/エラーのみ |
| **業務アプリデザイン** | 落ち着いた配色（青・緑・グレー）、派手なアイコン不使用 |
| **日本語UI** | 全メニュー・ラベルを日本語化 |
| **シンプルメニュー** | Client側は3項目のみ（Dashboard, Uploads, Results） |
| **土日ハイライト** | 土日を背景色・文字色で強調表示 |

### 12.3 開発環境

| 項目 | 内容 |
|------|------|
| **ローカルポート** | 3002 |
| **起動コマンド** | `cd web && npm run dev` |
| **アクセスURL** | http://localhost:3002 |
| **モックデータ** | 各ページのコンポーネント内に定義 |

### 12.4 未実装項目（今後の開発）

| 項目 | 優先度 | 備考 |
|------|--------|------|
| Google OAuth認証 | 高 | Phase 1で実装予定 |
| データベース接続（Neon） | 高 | Phase 1で実装予定 |
| Google Drive API連携 | 高 | Phase 3で実装予定 |
| CSV検証ロジック | 高 | Phase 4で実装予定 |
| Asana通知機能 | 中 | Phase 5で実装予定 |
| アップロード履歴詳細 | 中 | Phase 6で実装予定 |
| 出荷実績詳細 | 中 | Phase 7で実装予定 |
| Admin管理画面 | 中 | Phase 2で実装予定 |

---

## 13. 未決定事項・課題

### 13.1 Komaki 確認待ち

| 項目 | 内容 | 確認状況 |
|------|------|---------|
| DB選定 | Neon (PostgreSQL) で適切か | **確認待ち** |
| ファイル監視 | Google Drive Webhook の実現方式 | **確認待ち** |
| バックグラウンド処理 | Vercel Functions の処理時間制限 | **確認待ち** |

### 13.2 調査必要事項

| 項目 | 内容 |
|------|------|
| Google Drive API | 複数アカウント認証、Webhook設定方法 |
| Asana API | コメント追加API、タスクGID取得方法 |
| Neon | 接続プール設定、コールドスタート時間 |

---

## 14. 関連ドキュメント

### 14.1 F-Gateway設計書群

- [F-Gateway README](./README.md) - プロジェクト概要
- [設計書.md](./設計書.md) - 本ドキュメント（詳細設計書）
- **[UIデザイン設計書](./UIデザイン設計書.md)** - Vercel風の現代的なUIデザイン設計
- **[CSVマッピング設計書](./CSVマッピング設計書.md)** - CSV自動変換・柔軟マッピングの詳細設計
- **[商品マスタ管理設計書](./商品マスタ管理設計書.md)** - 商品マスタ管理の詳細設計
- **[技術補足設計書](./技術補足設計書.md)** - API設計、テスト、デプロイ、運用の詳細設計

### 14.2 関連システム設計書

- [クライアントID体系](../../IDSystem/02_クライアントID.md)
- [F-WMSPortal設計書](../F-WMSPortal/設計書.md)
- [Asana API仕様](../../ExternalSystems/Asana/README.md)
- [Google API仕様](../../ExternalSystems/Google/README.md)
- [アーキテクチャ設計書](../../System/アーキテクチャ設計書.md)
- [クライアント情報](../../Clients/クライアント情報.md)

---

## 更新履歴

| 日付 | 版数 | 更新内容 | 更新者 |
|------|------|---------|--------|
| 2026-01-28 | 0.7 | CSVマッピング設計書を新規作成。文字コード・改行コード自動検出、柔軟な項目マッピング、視覚的マッピングUI設計を策定 | Teppei & Claude |
| 2026-01-28 | 0.6 | UIデザイン設計書を新規作成。Vercel/Supabase風の現代的なUI設計を策定。固定サイドバー廃止、横並びナビゲーション、ブレッドクラム構造、Scope Selector、Command Menu等を導入 | Teppei & Claude |
| 2026-01-28 | 0.5 | 商品マスタ管理を最重要機能として拡充。巨大CSV対応、柔軟な項目マッピング、URL自動取得機能を追加。別途「商品マスタ管理設計書」を作成 | Teppei & Claude |
| 2026-01-28 | 0.4 | アプリの目的・提供価値を明確化、Google Drive設定を5種類に拡張（出庫予定・出庫実績・入庫予定・入庫実績・商品マスタ）、Asana通知をプロジェクト単位に変更、商品マスタ管理機能追加、デザインコンセプト追加、全UIを日本語化 | Teppei & Claude |
| 2026-01-28 | 0.3 | モックアップ実装完成。1日1CSV方式へ変更、カレンダー形式UI、処理プロセス非表示、Tailwind CSS 3.4.17採用、Client画面を3メニューに簡素化 | Teppei & Claude |
| 2026-01-26 | 0.2 | 大幅改訂（Neon採用、クライアント管理、複数Google Drive対応、Admin/Client分離、Asana通知設定） | Claude |
| 2026-01-26 | 0.1 | 初版作成（設計中） | Claude |
